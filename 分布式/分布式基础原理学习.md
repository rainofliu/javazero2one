# 分布式系统基本原理

## 分布式系统特点

分布式系统的核心是**可扩展性**

+ 通过对服务、存储的扩展，提高系统的处理能力。
  + 例如  集群
  + 例如  读写分离
  + 缓存
  + 分布式消息中间件
+ （**扩展结果：**）通过多台服务器协同工作，来完成单台服务器无法处理的能力，尤其是高并发或者大数据量的任务



+ 不出现单点故障（Single Point Failure）

  > 单点故障指的是系统中某个组件一旦失效，会让整个系统无法工作
  >
  > 而不出现单点故障，单点不影响整体是分布式系统设计的目标之一

+ 无状态

  > 因为无状态的服务才能满足部分机器宕机不影响全部，可以随时进行扩展
  >
  > + 我认为如果服务是有状态的，那么就不够自由，不容易扩展
  > + 如果服务有状态，那么其他服务一定会记录当前服务的状态，那么如果当前服务宕机，其他服务还保存着宕机服务的状态，就可能会对其他服务产生影响

## CAP原理

### CAP理论

CAP理论：**一个分布式系统最多只能同时满足一致性（Consistency）、可用性(Availability)和分区容忍性(Partition Tolerance)这三项中的两项**

> 首先最多只能满足两项，如果分布式系统设计不合理，也可能只满足一项或者一项都不能满足，那真的是boom！

![](https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/CAP.png)

### 一致性

所有节点同时看到相同的数据

> 即更新操作并返回客户端完成后，所有节点在同一时间的数据完全一致，也就是说所有节点拥有数据的最新版本
>
> + 一致性讨论的前提一定是数据发生变化（更新），只读场景数据不变，讨论一致性没有必要，但是只读场景现实中应该是不存在的

### 可用性

任何时候，读写都是成功的

> 服务一直可用，而且是正常响应时间
>
> + 服务一直可用，但是卡的不行，这种情况是不算的

数值衡量： 3个9  4个9（是用时间来作为量化标准的，一年365天可用多少天）

### 分区容忍性

当部分节点出现消息丢失或者分区故障的同时分布式系统仍然能够继续运行

> 即系统容忍网络出现分区，且在遇到某个节点或网络分区之间网络不可达的情况下，仍然能够对外提供满足一致性和可用性的服务
>
> + 分区容忍性重在容忍，允许网络分区故障  -- 包容性
> + 容忍网络分区故障时还能继续对外提供服务 

### 证明CAP理论

我们采取**反证法**，假设CAP三者全部满足，假设P存在，那么C一定不存在

我们再给CAP下一个更精准的定义：

+ Consistency

  > 一致性被称为原子对象，任何的读写看起来都应该是“原子”的，或串行的
  >
  > 写操作后面的读操作一定能读到前面写的内容，所有的读写请求都好像被全局排序
  >
  > 其实就类似Java内存模型里所说的原子性和可见性

+ Availability

  对任何非失败节点都应该在有限时间内给出请求的回应（请求的可中止性）

+ Partition Tolerance

  允许节点之间丢失任意多的消息，当网络分区发生时，节点之间的消息可能会完全丢失

### CAP理论的应用

> CAP 理论提醒我们，在架构设计中，不要把精力浪费在如何设计能满足三者的完美分布式系统上，而要**合理进行取舍**，CAP 理论类似数学上的不可能三角，只能三者选其二，不能全部获得。

不同业务对一致性的要求是不同的，我们需要注意，CAP理论中是**忽视网络延时的**，也就是当事务提交时，节点间的数据复制一定是需要花费时间的。即使是同一个机房，从节点 A 复制到节点 B，由于现实中网络不是实时的，所以总会有一定的时间不一致。

#### CP和AP的取舍

在通常的分布式系统中，为了保证数据的高可用，通常会将数据保存多个副本(Replica) ，网络分区是既成事实，于是只能在可用性和一致性之间做出取舍。

> **CAP 理论关注的是在绝对情况下，在工程上，可用性和一致性并不是完全对立的，我们关注的往往是如何在保持相对一致性的前提下，提高系统的可用性。**

##### CP架构

对于 CP 来说，放弃可用性，追求一致性和分区容错性。

> 我们熟悉的ZooKeeper，就是采用了CP一致性，ZooKeeper是一个分布式的服务框架，主要用来解决分布式集群中应用系统的协调和一致性问题。其核心算法是Zab，所有设计都是为了一致性。在 CAP 模型中，ZooKeeper 是 CP，这意味着面对网络分区时，为了保持一致性，它是不可用的。

##### AP架构

对于 AP 来说，放弃强一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择，Base 理论也是根据 AP 来扩展的

> 和ZooKeeper相对的是Eureka，Eureka是SpringCloud微服务技术栈中的服务发现组件，Eureka的各个节点都是平等的，几个节点挂掉不影响正常节点的工作，剩余的节点依然可以提供注册和查询服务，只要有一台 Eureka 还在，就能保证注册服务可用，只不过查到的信息可能不是最新的版本，不保证一致性。

##  Base理论

Base是三个短语的简写，即基本可用（Basically Avaliable）、软状态(Soft Sate) 和最终一致性(Eventually Consistent)

![](https://liutianruo-2019-go-go-go.oss-cn-shanghai.aliyuncs.com/images/Base图.png)

Base理论的核心思想是最终一致性，即使无法做到强一致性(Strong Consitency)，但每个应用可以根据自身业务的特点，采取适当的方式来使系统达到最终一致性

> Base理论是对现实的妥协，强一致性有时候很难满足，所以可以通过最终一致性来替代

### 基本可用

不追求CAP中“任何时候读写都是成功的”，而是系统能够基本运行，持续提供服务。

> 基本可用强调了分布式系统在出现不可预知故障时，允许损失部分可用性，相比正常的系统，可能是响应时间延长，或者是服务被降级。

### 软状态

软状态可以对应到ACID事务中的原子性，在ACID的事务中实现的是强一致性，要么全做要么全不做，所有用户看到的状态一致。其中的原子性（Atomicity）要求多个节点的数据副本都是一致的，强调数据的一致性。

> 原子性可以理解为一种“硬状态”，软状态则是允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时
>

### 最终一致性

**数据不可能一直是软状态，必须在一个时间期限之后达到各个节点的一致性**，在期限过后，应当保证所有副本保持数据一致性，也就是达到数据的最终一致性。

**在系统设计中，最终一致性实现的时间取决于网络延时、系统负载、不同的存储选型、不同数据复制方案设计等因素。**

#### 全局时钟和逻辑时钟

分布式系统虽然解决了单体架构的单点故障和性能容量问题，但同时带来了新的问题，就是**多节点的时间同步问题。**

> 很简单的，不同的手表时间可能会出现不一致的情况；而不同机器上的物理时钟难以同步（保持一致），导致**无法区分在分布式系统中多个节点的事件时序**。

没有全局时钟，绝对的内部一致性是没有意义的，一般来说，我们讨论的一致性是外部一致性，而外部一致性主要指的是多并发访问时更新过的数据如何获取的问题。

**和全局时钟相对的，是逻辑时钟，逻辑时钟描绘了分布式系统中事件发生的时序，是为了区分现实中的物理时钟提出来的概念。**

一般情况下我们提到的时间都是指物理时间，但实际上很多应用中，只要所有机器有相同的时间就够了，这个时间不一定要跟实际时间相同

更进一步解释：**如果两个节点之间不进行交互，那么它们的时间甚至都不需要同步。 因此问题的关键点在于节点间的交互要在事件的发生顺序上达成一致，而不是对于时间达成一致。**

#### 不同数据一致性模型

> 一般来说，数据模型分为强一致性和弱一致性。

在互联网领域的绝大多数场景中，都需要**牺牲强一致性来换取分布式系统的高可用**，**系统往往只需要保证“最终一致性”**，只要这个最终时间是在用户可以接受的范围内就行。

##### 强一致性

当更新操作完成之后，任何多个后续进程的访问都会返回最新的更新过的值，这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么。**根据 CAP 理论，这种实现需要牺牲可用性。**

##### 弱一致性

系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到。用户读到某一操作对系统数据的更新需要一段时间，我们称这段时间为“不一致性窗口”

##### 最终一致性

最终一致性是弱一致性的特例，**强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一个一致的状态**。因此，最终一致性的本质是需要**系统保证最终数据能够达到一致**，而**不需要实时保证系统数据的强一致性。**

###### 因果一致性

因果一致性要求有因果关系的操作顺序得到保证，非因果关系的操作顺序则无所谓

> 发朋友圈，朋友评论时间和我回复评论时间的先后顺序要保证正确。

###### 会话一致性

会话一致性将对系统数据的访问过程框定在了一个会话当中，约定了系统能保证在同一个有效的会话中实现“读己之所写”的一致性。就是在你的一次访问中，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值。

## CAP理论与Base理论的关联

Base 理论是在 CAP 上发展的，CAP 理论描述了分布式系统中数据一致性、可用性、分区容错性之间的制约关系，当你选择了其中的两个时，就不得不对剩下的一个做一定程度的牺牲。

Base 理论则是对 CAP 理论的实际应用，也就是在分区和副本存在的前提下，通过一定的系统设计方案，放弃强一致性，实现基本可用，这是大部分分布式系统的选择，比如 NoSQL 系统、微服务架构。在这个前提下，如何把基本可用做到最好，就是分布式工程师们追求的。

除了 CAP 和 Base，还有ACID 原理，ACID 是一种**强一致性模型**，强调原子性、一致性、隔离性和持久性，主要用于在数据库实现中。

> Base 理论面向的是**高可用、可扩展**的分布式系统，ACID 适合传统金融等业务（一致性要求较高），在实际场景中，不同业务对数据的一致性要求不一样，ACID 和 Base 理论往往会结合使用。
>
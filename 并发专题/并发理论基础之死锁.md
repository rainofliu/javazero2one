[toc]

**死锁的一个比较专业的定义是：一组互相竞争资源的线程因互相等待，导致“永久”阻塞的现象。**

# 如何避免死锁

并发程序一旦死锁，一般没有特别好的方法，很多时候我们只能重启应用。

因此，解决死锁问题最好的办法还是**规避死锁**。

那如何避免死锁呢？**要避免死锁就需要分析死锁发生的条件**，

有个叫 Coffman 的牛人早就总结过了，只有以下这四个条件都发生时才会出现死锁：

1. 互斥，共享资源 X 和 Y 只能被一个线程占用；

2. 占有且等待，线程 T1 已经取得共享资源 X，在等待共享资源 Y 的时候，不释放共享资源 X；

3. 不可抢占，其他线程不能强行抢占线程 T1 占有的资源；

4. 循环等待，线程 T1 等待线程 T2 占有的资源，线程 T2 等待线程 T1 占有的资源，就是循环等待。

>反过来分析，也就是说**只要我们破坏其中一个，就可以成功避免死锁的发生**
>
>互斥条件很难破坏，但其他三个条件都可以破坏

1. 对于“占用且等待”这个条件，我们可以**一次性申请所有的资源，这样就不存在等待了**。

2. 对于“不可抢占”这个条件，占用部分资源的线程进一步申请其他资源时，如果申请不到，可以主动释放它占有的资源，这样不可抢占这个条件就破坏掉了。

   > 破坏不可抢占条件看上去很简单，核心是要能够主动释放它占有的资源，这一点 `synchronized` 是做不到的。原因是 synchronized 申请资源的时候，如果申请不到，线程直接进入阻塞状态了，而线程进入阻塞状态，啥都干不了，也释放不了线程已经占有的资源。
   >
   > **`java.util.concurrent` 这个包下面提供的 `Lock` 是可以轻松解决这个问题**

3. 对于“循环等待”这个条件，可以靠**按序申请资源**来预防。所谓按序申请，是指资源是有线性顺序的，申请的时候可以先申请资源序号小的，再申请资源序号大的，这样线性化后自然就不存在循环了。

   > 破坏这个条件，需要对资源进行排序，然后按序申请资源。这个实现非常简单，我们假设每个账户都有不同的属性 id，这个 id 可以作为排序字段，**申请的时候，我们可以按照从小到大的顺序来申请**。	

   ```java
   class Account {
     private int id;
     private int balance;
     // 转账
     void transfer(Account target, int amt){
       Account left = this        ①
       Account right = target;    ②
       if (this.id > target.id) { ③
         left = target;           ④
         right = this;            ⑤
       }                          ⑥
       // 锁定序号小的账户
       synchronized(left){
         // 锁定序号大的账户
         synchronized(right){ 
           if (this.balance > amt){
             this.balance -= amt;
             target.balance += amt;
           }
         }
       }
     } 
   }
   ```

## 优秀的评论区

   1. 最常见的就是B转A的同时，A转账给B，那么先锁B再锁A，但是，另一个线程是先锁A再锁B，然而，如果两个线程同时执行，那么就是出现死锁的情况，线程T1锁了A请求锁B，此时线程T2锁了B请求锁A，都在等着对方释放锁，然而自己都不会释放锁，故死锁。
      最简单的办法，就是无论哪个线程执行的时候，都按照顺序加锁，即按照A和B的id大小来加锁，这样，无论哪个线程执行的时候，都会先加锁A，再加锁B，A被加锁，则等待释放。这样就不会被死锁了。	

   2. 联想了下实际转账业务，应该是数据库来实现的，假如有账户表account，利用mysql的悲观锁select ...for update对a，b两条数据锁定，这时也**有可能发生死锁**，按照您讲到的第三种破坏循环等待的方式，**按照id的大小顺序依次锁定**。

   3. 对于第三点，按资源顺序来锁就能打破循环等待有疑问。
      例如：账户 1 向 账户 3 转账
       同时 账户 3 向 账户 5 转账
      即使按资源顺序来锁，也是起不了啥作用吧！？

      